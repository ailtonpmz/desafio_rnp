{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": 28,
  "links": [],
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 3,
      "panels": [],
      "title": "Questão 1: Agente de monitoramento web",
      "type": "row"
    },
    {
      "datasource": {
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "neutral": -1
          },
          "fieldMinMax": true,
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "green"
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "loss {site=\"rnp\", target=\"rnp.br\", test_type=\"ping\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Loss"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "percentage",
                  "steps": [
                    {
                      "color": "dark-green"
                    },
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 0.1
                    },
                    {
                      "color": "#EAB839",
                      "value": 1
                    },
                    {
                      "color": "dark-red",
                      "value": 1.01
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "rtt_avg {site=\"rnp\", target=\"rnp.br\", test_type=\"ping\"}"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "displayName",
                "value": "RTT"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green"
                    },
                    {
                      "color": "green",
                      "value": 50
                    },
                    {
                      "color": "#EAB839",
                      "value": 51
                    },
                    {
                      "color": "dark-red",
                      "value": 151
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "load_time {site=\"rnp\", test_type=\"page_load\", url=\"https://rnp.br\"}"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "displayName",
                "value": "Load Time"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green"
                    },
                    {
                      "color": "green",
                      "value": 1000
                    },
                    {
                      "color": "#EAB839",
                      "value": 1001
                    },
                    {
                      "color": "dark-red",
                      "value": 2000
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "status_code {site=\"rnp\", test_type=\"page_load\", url=\"https://rnp.br\"}"
            },
            "properties": [
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "200": {
                        "color": "green",
                        "index": 1,
                        "text": "OK - (200)"
                      },
                      "404": {
                        "color": "red",
                        "index": 0,
                        "text": "Erro - (404)"
                      }
                    },
                    "type": "value"
                  }
                ]
              },
              {
                "id": "displayName",
                "value": "HTTP Status"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 5,
        "w": 9,
        "x": 0,
        "y": 1
      },
      "id": 9,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": false,
        "sizing": "manual"
      },
      "pluginVersion": "11.6.0",
      "targets": [
        {
          "query": "from(bucket: \"viaipe\") |> range(start: v.timeRangeStart, stop: v.timeRangeStop) |> filter(fn: (r) => r.site == \"rnp\") |> filter(fn: (r) => r._field == \"loss\" or r._field == \"rtt_avg\" or r._field == \"status_code\" or r._field == \"load_time\") |> aggregateWindow(every: v.windowPeriod, fn: mean) |> yield(name: \"mean\")",
          "refId": "A"
        }
      ],
      "title": "rnp.br",
      "type": "gauge"
    },
    {
      "datasource": {
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "cellOptions": {
              "type": "color-text"
            },
            "filterable": false,
            "inspect": false
          },
          "decimals": 2,
          "mappings": [],
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "dark-green"
              },
              {
                "color": "#EAB839",
                "value": 1
              },
              {
                "color": "red",
                "value": 3
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "local"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Localidade"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "perda"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Perda de Pacotes (%)"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 15,
        "w": 6,
        "x": 9,
        "y": 1
      },
      "id": 15,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "countRows": false,
          "enablePagination": true,
          "fields": "",
          "reducer": ["sum"],
          "show": false
        },
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Perda de Pacotes (%)"
          }
        ]
      },
      "pluginVersion": "11.6.0",
      "targets": [
        {
          "query": "from(bucket: \"viaipe\")\n  |> range(start: -24h)\n  |> filter(fn: (r) => r._measurement == \"viaipe_location_metrics\")\n  |> filter(fn: (r) => r._field == \"smoke_loss\")\n  |> filter(fn: (r) => r._value > 0.0)\n  |> group(columns: [\"location_name\"])\n  |> last()\n  |> map(fn: (r) => ({\n      local: r.location_name,\n      perda: r._value\n  }))\n  |> sort(columns: [\"perda\"] , desc: true)",
          "refId": "A"
        }
      ],
      "title": "Locais com Perda de Pacotes > 0%",
      "transparent": true,
      "type": "table"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "fieldMinMax": false,
          "mappings": [],
          "max": 1000,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green"
              }
            ]
          },
          "unit": "MBs"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 15,
        "w": 9,
        "x": 15,
        "y": 1
      },
      "id": 16,
      "options": {
        "basemap": {
          "config": {
            "server": "streets",
            "showLabels": true,
            "theme": "auto"
          },
          "name": "Layer 0",
          "opacity": 1,
          "tooltip": false,
          "type": "osm-standard"
        },
        "controls": {
          "mouseWheelZoom": true,
          "showAttribution": true,
          "showDebug": false,
          "showMeasure": false,
          "showScale": true,
          "showZoom": true
        },
        "layers": [
          {
            "config": {
              "showLegend": false,
              "style": {
                "color": {
                  "fixed": "dark-purple"
                },
                "opacity": 1,
                "rotation": {
                  "field": "Capacidade (Gbps)",
                  "fixed": 0,
                  "max": 360,
                  "min": -360,
                  "mode": "mod"
                },
                "size": {
                  "field": "Capacidade (Gbps)",
                  "fixed": 15,
                  "max": 7,
                  "min": 5
                },
                "symbol": {
                  "fixed": "img/icons/marker/circle.svg",
                  "mode": "fixed"
                },
                "symbolAlign": {
                  "horizontal": "center",
                  "vertical": "center"
                },
                "text": {
                  "field": "Instituição",
                  "fixed": "",
                  "mode": "fixed"
                },
                "textConfig": {
                  "fontSize": 12,
                  "offsetX": 0,
                  "offsetY": 0,
                  "textAlign": "center",
                  "textBaseline": "middle"
                }
              }
            },
            "filterData": {
              "id": "byRefId",
              "options": "A"
            },
            "name": "Local",
            "tooltip": true,
            "type": "markers"
          }
        ],
        "tooltip": {
          "mode": "none"
        },
        "view": {
          "allLayers": true,
          "id": "coords",
          "lastOnly": false,
          "lat": -2.611313,
          "layer": "Layer 1",
          "lon": -54.995532,
          "shared": false,
          "zoom": 4.5
        }
      },
      "pluginVersion": "11.6.0",
      "targets": [
        {
          "query": "queryRange = -7d\nlocation_data = from(bucket: \"viaipe\")\n  |> range(start: queryRange)\n  |> filter(fn: (r) => r._measurement == \"viaipe_location_metrics\")\n  |> filter(fn: (r) => r.location_name =~ /^${location:regex}$/)\n  |> filter(fn: (r) => r._field == \"lat\" or r._field == \"lng\" or r._field == \"location_id\")\n  |> group(columns: [\"location_name\", \"_field\"])\n  |> last()\n  |> group(columns: [\"location_name\"])\n  |> pivot(rowKey:[\"location_name\"], columnKey: [\"_field\"], valueColumn: \"_value\")\n  |> keep(columns: [\"location_name\", \"lat\", \"lng\", \"location_id\"])\n\ninterface_capacity = from(bucket: \"viaipe\")\n  |> range(start: queryRange)\n  |> filter(fn: (r) => r._measurement == \"viaipe_interface_metrics\")\n  |> filter(fn: (r) => r.location_name =~ /^${location:regex}$/)\n  |> filter(fn: (r) => r._field == \"interface_max_traffic_up\")\n  |> group(columns: [\"location_name\", \"interface_name\", \"_field\"])\n  |> last()\n  |> group(columns: [\"location_name\"])\n  |> max(column: \"_value\")\n  |> rename(columns: {_value: \"max_traffic_up_bits\"})\n  |> keep(columns: [\"location_name\", \"max_traffic_up_bits\"])\n\njoin(tables: {loc: location_data, cap: interface_capacity}, on: [\"location_name\"], method: \"inner\")\n\n  |> map(fn: (r) => {\n      loc_id_str = if exists r.location_id then string(v: r.location_id) else \"??\"\n      return {\n        Instituição: r.location_name,\n        lat: r.lat,\n        lng: r.lng,\n        \"Capacidade (Gbps)\": float(v: r.max_traffic_up_bits) / 1000000.0,\n        \"Local PoP\": \"PoP-\" + loc_id_str\n      }\n   })\n  |> keep(columns: [\"Instituição\", \"lat\", \"lng\", \"Capacidade (Gbps)\", \"Local PoP\"])",
          "refId": "A"
        }
      ],
      "title": "Brasil",
      "transparent": true,
      "type": "geomap"
    },
    {
      "datasource": {
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "neutral": -1
          },
          "fieldMinMax": true,
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "green"
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "loss {site=\"google\", target=\"google.com\", test_type=\"ping\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Loss"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "percentage",
                  "steps": [
                    {
                      "color": "dark-green"
                    },
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 0.1
                    },
                    {
                      "color": "#EAB839",
                      "value": 1
                    },
                    {
                      "color": "dark-red",
                      "value": 1.01
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "rtt_avg {site=\"google\", target=\"google.com\", test_type=\"ping\"}"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "displayName",
                "value": "RTT"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green"
                    },
                    {
                      "color": "green",
                      "value": 50
                    },
                    {
                      "color": "#EAB839",
                      "value": 51
                    },
                    {
                      "color": "dark-red",
                      "value": 151
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "load_time {site=\"google\", test_type=\"page_load\", url=\"https://google.com\"}"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "displayName",
                "value": "Load Time"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green"
                    },
                    {
                      "color": "green",
                      "value": 1000
                    },
                    {
                      "color": "#EAB839",
                      "value": 1001
                    },
                    {
                      "color": "dark-red",
                      "value": 2000
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "status_code {site=\"google\", test_type=\"page_load\", url=\"https://google.com\"}"
            },
            "properties": [
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "200": {
                        "color": "green",
                        "index": 1,
                        "text": "OK - (200)"
                      },
                      "404": {
                        "color": "red",
                        "index": 0,
                        "text": "Erro - (404)"
                      }
                    },
                    "type": "value"
                  }
                ]
              },
              {
                "id": "displayName",
                "value": "HTTP Status"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 5,
        "w": 9,
        "x": 0,
        "y": 6
      },
      "id": 11,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": false,
        "sizing": "manual"
      },
      "pluginVersion": "11.6.0",
      "targets": [
        {
          "query": "from(bucket: \"viaipe\") |> range(start: v.timeRangeStart, stop: v.timeRangeStop) |> filter(fn: (r) => r.site == \"google\") |> filter(fn: (r) => r._field == \"loss\" or r._field == \"rtt_avg\" or r._field == \"status_code\" or r._field == \"load_time\") |> aggregateWindow(every: v.windowPeriod, fn: mean) |> yield(name: \"mean\")",
          "refId": "A"
        }
      ],
      "title": "google.com",
      "type": "gauge"
    },
    {
      "datasource": {
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "neutral": -1
          },
          "fieldMinMax": true,
          "mappings": [],
          "max": 100,
          "min": 0,
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "green"
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "loss {site=\"youtube\", target=\"youtube.com\", test_type=\"ping\"}"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Loss"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "percentage",
                  "steps": [
                    {
                      "color": "dark-green"
                    },
                    {
                      "color": "green",
                      "value": 0
                    },
                    {
                      "color": "yellow",
                      "value": 0.1
                    },
                    {
                      "color": "#EAB839",
                      "value": 1
                    },
                    {
                      "color": "dark-red",
                      "value": 1.01
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "rtt_avg {site=\"youtube\", target=\"youtube.com\", test_type=\"ping\"}"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "displayName",
                "value": "RTT"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green"
                    },
                    {
                      "color": "green",
                      "value": 50
                    },
                    {
                      "color": "#EAB839",
                      "value": 51
                    },
                    {
                      "color": "dark-red",
                      "value": 151
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "load_time {site=\"youtube\", test_type=\"page_load\", url=\"https://youtube.com\"}"
            },
            "properties": [
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "displayName",
                "value": "Load Time"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green"
                    },
                    {
                      "color": "green",
                      "value": 1000
                    },
                    {
                      "color": "#EAB839",
                      "value": 1001
                    },
                    {
                      "color": "dark-red",
                      "value": 2000
                    }
                  ]
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "status_code {site=\"youtube\", test_type=\"page_load\", url=\"https://youtube.com\"}"
            },
            "properties": [
              {
                "id": "mappings",
                "value": [
                  {
                    "options": {
                      "200": {
                        "color": "green",
                        "index": 1,
                        "text": "OK - (200)"
                      },
                      "404": {
                        "color": "red",
                        "index": 0,
                        "text": "Erro - (404)"
                      }
                    },
                    "type": "value"
                  }
                ]
              },
              {
                "id": "displayName",
                "value": "HTTP Status"
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 5,
        "w": 9,
        "x": 0,
        "y": 11
      },
      "id": 10,
      "options": {
        "minVizHeight": 75,
        "minVizWidth": 75,
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": false,
        "sizing": "manual"
      },
      "pluginVersion": "11.6.0",
      "targets": [
        {
          "query": "from(bucket: \"viaipe\") |> range(start: v.timeRangeStart, stop: v.timeRangeStop) |> filter(fn: (r) => r.site == \"youtube\") |> filter(fn: (r) => r._field == \"loss\" or r._field == \"rtt_avg\" or r._field == \"status_code\" or r._field == \"load_time\") |> aggregateWindow(every: v.windowPeriod, fn: mean) |> yield(name: \"mean\")",
          "refId": "A"
        }
      ],
      "title": "youtube.com",
      "type": "gauge"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 16
      },
      "id": 2,
      "panels": [],
      "title": "Opção 2 - Localidade ViaIpe",
      "type": "row"
    },
    {
      "datasource": {
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "fieldMinMax": false,
          "mappings": [],
          "thresholds": {
            "mode": "percentage",
            "steps": [
              {
                "color": "dark-green"
              },
              {
                "color": "green",
                "value": 30
              },
              {
                "color": "dark-yellow",
                "value": 40
              },
              {
                "color": "orange",
                "value": 70
              },
              {
                "color": "#E24D42",
                "value": 90
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "instituicao"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Instituição"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "capacidade"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Capacidade (Gbps)"
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "dark-red"
                    },
                    {
                      "color": "dark-yellow",
                      "value": 100
                    },
                    {
                      "color": "dark-yellow",
                      "value": 200
                    },
                    {
                      "color": "dark-green",
                      "value": 400
                    },
                    {
                      "color": "dark-green",
                      "value": 401
                    }
                  ]
                }
              },
              {
                "id": "unit",
                "value": "Mbits"
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "latencia"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Latência (ms)"
              },
              {
                "id": "unit",
                "value": "ms"
              },
              {
                "id": "decimals",
                "value": 2
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "dark-green"
                    },
                    {
                      "color": "green",
                      "value": 30
                    },
                    {
                      "color": "#EAB839",
                      "value": 100
                    },
                    {
                      "color": "#EF843C",
                      "value": 150
                    },
                    {
                      "color": "dark-red",
                      "value": 300
                    }
                  ]
                }
              },
              {
                "id": "min",
                "value": 301
              },
              {
                "id": "max",
                "value": 0
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "local"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Local"
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "disponibilidade"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Disponibilidade (%)"
              },
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "decimals",
                "value": 2
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "dark-red"
                    },
                    {
                      "color": "#EAB839",
                      "value": 99
                    },
                    {
                      "color": "green",
                      "value": 99.5
                    }
                  ]
                }
              },
              {
                "id": "min",
                "value": 0
              },
              {
                "id": "max",
                "value": 100
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "consumo_in_mbps"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Consumo Médio In (Mbps)"
              },
              {
                "id": "unit",
                "value": "mbps"
              },
              {
                "id": "decimals",
                "value": 2
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "consumo_out_mbps"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Consumo Médio Out (Mbps)"
              },
              {
                "id": "unit",
                "value": "mbps"
              },
              {
                "id": "decimals",
                "value": 2
              },
              {
                "id": "color",
                "value": {
                  "fixedColor": "text",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "qualidade"
            },
            "properties": [
              {
                "id": "displayName",
                "value": "Qualidade (%)"
              },
              {
                "id": "unit",
                "value": "percent"
              },
              {
                "id": "decimals",
                "value": 2
              },
              {
                "id": "thresholds",
                "value": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "dark-red"
                    },
                    {
                      "color": "#EAB839",
                      "value": 80
                    },
                    {
                      "color": "green",
                      "value": 90
                    }
                  ]
                }
              },
              {
                "id": "min",
                "value": 0
              },
              {
                "id": "max",
                "value": 100
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 5,
        "w": 24,
        "x": 0,
        "y": 17
      },
      "id": 1,
      "maxPerRow": 3,
      "options": {
        "displayMode": "basic",
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "maxVizHeight": 57,
        "minVizHeight": 16,
        "minVizWidth": 8,
        "namePlacement": "auto",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "limit": 25,
          "values": false
        },
        "showUnfilled": true,
        "sizing": "auto",
        "text": {},
        "valueMode": "color"
      },
      "pluginVersion": "11.6.0",
      "repeat": "location",
      "repeatDirection": "h",
      "targets": [
        {
          "query": "// --- Consulta Flux Corrigida (sem médias 24h, com disponibilidade e consumo Mbps) ---\n\n// Pega dados recentes das interfaces (agregando soma e max)\nrecent_interfaces_agg = from(bucket: \"viaipe\")\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n    |> filter(fn: (r) => r._measurement == \"viaipe_interface_metrics\")\n    |> filter(fn: (r) => r.location_name == \"${location}\")\n    |> filter(fn: (r) => r._field == \"interface_avg_out\" or\n                         r._field == \"interface_avg_in\" or\n                         r._field == \"interface_max_traffic_up\" or\n                         r._field == \"interface_max_traffic_down\")\n    |> group(columns: [\"location_name\", \"_field\"])\n    |> last()\n    |> group(columns: [\"location_name\"])\n    |> reduce(\n        identity: {\n            _time: time(v:0), location_name: \"${location}\", total_avg_out: 0.0, total_avg_in: 0.0,\n            max_traffic_up: 0.0, max_traffic_down: 0.0\n        },\n        fn: (r, accumulator) => ({\n            _time: r._time,\n            location_name: r.location_name,\n            total_avg_out: (if r._field == \"interface_avg_out\" then float(v: r._value) else 0.0) + accumulator.total_avg_out,\n            total_avg_in: (if r._field == \"interface_avg_in\" then float(v: r._value) else 0.0) + accumulator.total_avg_in,\n            max_traffic_up: (if r._field == \"interface_max_traffic_up\" and float(v: r._value) > accumulator.max_traffic_up then float(v: r._value) else accumulator.max_traffic_up),\n            max_traffic_down: (if r._field == \"interface_max_traffic_down\" and float(v: r._value) > accumulator.max_traffic_down then float(v: r._value) else accumulator.max_traffic_down)\n        })\n    )\n    |> keep(columns: [\"location_name\", \"total_avg_out\", \"total_avg_in\", \"max_traffic_up\", \"max_traffic_down\"])\n\n// Pega dados recentes da localização (smoke, lat/lng)\nrecent_location_data = from(bucket: \"viaipe\")\n    |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n    |> filter(fn: (r) => r._measurement == \"viaipe_location_metrics\")\n    |> filter(fn: (r) => r.location_name == \"${location}\")\n    |> filter(fn: (r) => r._field == \"smoke_avg_val\" or r._field == \"smoke_loss\" or r._field == \"location_id\")\n    |> last()\n    |> pivot(rowKey: [\"location_name\"], columnKey: [\"_field\"] , valueColumn: \"_value\")\n    |> keep(columns: [\"location_name\", \"smoke_avg_val\", \"smoke_loss\", \"location_id\"])\n\n\n// Junta: Recente Local + Recente Interfaces (agregado)\nfinal_data = join(tables: {loc: recent_location_data, iface: recent_interfaces_agg}, on: [\"location_name\"] , method: \"inner\")\n\n// Mapeia para o formato final\nfinal_data\n    |> map(fn: (r) => {\n        loc_name = r.location_name\n        max_up = if exists r.max_traffic_up then float(v: r.max_traffic_up) else 0.0\n        // max_down = if exists r.max_traffic_down then float(v: r.max_traffic_down) else 0.0 // Não é mais necessário para os campos restantes\n        avg_out = if exists r.total_avg_out then float(v: r.total_avg_out) else 0.0\n        avg_in = if exists r.total_avg_in then float(v: r.total_avg_in) else 0.0\n        smoke_avg_val = if exists r.smoke_avg_val then float(v: r.smoke_avg_val) else 0.0 // Latência em ms\n        smoke_loss = if exists r.smoke_loss then float(v: r.smoke_loss) else 0.0 // Perda em %\n\n        // Calcula novas métricas\n        availability = 100.0 - smoke_loss\n        consumo_in_mbps = avg_in * 8.0 / 1000000.0\n        consumo_out_mbps = avg_out * 8.0 / 1000000.0\n        qualidade_score = 100.0 - (smoke_loss * 2.0) - (smoke_avg_val / 10.0)\n\n        return {\n            instituicao: loc_name,\n            capacidade: max_up / 1000000.0, // Em Mbps\n            latencia: smoke_avg_val,\n            disponibilidade: availability,\n            consumo_in_mbps: consumo_in_mbps,\n            consumo_out_mbps: consumo_out_mbps,\n            qualidade: if qualidade_score < 0.0 then 0.0 else qualidade_score // Garante que não seja negativo\n        }\n    })\n    |> group(columns: [\"instituicao\"]) // Re-agrupa para o Bar Gauge repetir corretamente\n",
          "refId": "A"
        }
      ],
      "title": "Localidade - ${location}",
      "type": "bargauge"
    }
  ],
  "preload": false,
  "refresh": "30s",
  "schemaVersion": 41,
  "tags": [],
  "templating": {
    "list": [
      {
        "current": {
          "text": "All",
          "value": ["$__all"]
        },
        "definition": "import \"influxdata/influxdb/v1\"\nqueryRange = -30m\n\nlocations_with_metrics = from(bucket: \"viaipe\")\n  |> range(start: queryRange)\n  |> filter(fn: (r) => r._measurement == \"viaipe_location_metrics\")\n  |> filter(fn: (r) => r._field == \"smoke_loss\" or r._field == \"smoke_avg_val\") // Campos chave usados no painel\n  |> keep(columns: [\"location_name\"])\n  |> distinct(column: \"location_name\")\n\nlocations_with_interfaces = from(bucket: \"viaipe\")\n  |> range(start: queryRange)\n  |> filter(fn: (r) => r._measurement == \"viaipe_interface_metrics\")\n  |> filter(fn: (r) => r._field == \"interface_avg_in\" or r._field == \"interface_avg_out\" or r._field == \"interface_max_traffic_up\") // Campos chave\n  |> keep(columns: [\"location_name\"])\n  |> distinct(column: \"location_name\")\n\nactive_locations = join(\n    tables: {metrics: locations_with_metrics, interfaces: locations_with_interfaces},\n    on: [\"location_name\"],\n    method: \"inner\"\n  )\n  |> keep(columns: [\"location_name\"])\n  |> rename(columns: {location_name: \"_value\"})\n  |> group() // Remove o agrupamento antes de retornar\n  |> sort(columns: [\"_value\"])\n\nactive_locations",
        "hide": 1,
        "includeAll": true,
        "multi": true,
        "name": "location",
        "options": [],
        "query": {
          "query": "import \"influxdata/influxdb/v1\"\nqueryRange = -30m\n\nlocations_with_metrics = from(bucket: \"viaipe\")\n  |> range(start: queryRange)\n  |> filter(fn: (r) => r._measurement == \"viaipe_location_metrics\")\n  |> filter(fn: (r) => r._field == \"smoke_loss\" or r._field == \"smoke_avg_val\") // Campos chave usados no painel\n  |> keep(columns: [\"location_name\"])\n  |> distinct(column: \"location_name\")\n\nlocations_with_interfaces = from(bucket: \"viaipe\")\n  |> range(start: queryRange)\n  |> filter(fn: (r) => r._measurement == \"viaipe_interface_metrics\")\n  |> filter(fn: (r) => r._field == \"interface_avg_in\" or r._field == \"interface_avg_out\" or r._field == \"interface_max_traffic_up\") // Campos chave\n  |> keep(columns: [\"location_name\"])\n  |> distinct(column: \"location_name\")\n\nactive_locations = join(\n    tables: {metrics: locations_with_metrics, interfaces: locations_with_interfaces},\n    on: [\"location_name\"],\n    method: \"inner\"\n  )\n  |> keep(columns: [\"location_name\"])\n  |> rename(columns: {location_name: \"_value\"})\n  |> group() // Remove o agrupamento antes de retornar\n  |> sort(columns: [\"_value\"])\n\nactive_locations",
          "refId": "StandardVariableQuery"
        },
        "refresh": 1,
        "sort": 1,
        "type": "query"
      }
    ]
  },
  "time": {
    "from": "now-30m",
    "to": "now"
  },
  "timepicker": {
    "nowDelay": "5s",
    "refresh_intervals": [
      "15s",
      "30s",
      "1m",
      "5m",
      "15m",
      "30m",
      "1h",
      "2h",
      "1d"
    ]
  },
  "timezone": "browser",
  "title": "Monitoramento ViaIpe - Instituições v1.1 Map",
  "uid": "ppmzrnpv1Map",
  "version": 2
}
